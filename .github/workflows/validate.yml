name: CI â€” validate schema & samples

on:
pull_request:
paths:
- 'schema/schema.json'
- 'examples/**/*.ndjson'
- '.github/workflows/validate.yml'
- 'README.md'
push:
branches: [ main ]
paths:
- 'schema/schema.json'
- 'examples/**/*.ndjson'
- '.github/workflows/validate.yml'

jobs:
validate:
runs-on: ubuntu-latest
steps:
- uses: actions/checkout@v4

- uses: actions/setup-python@v5
with:
python-version: '3.11'

- name: Install deps
run: |
python -m pip install --upgrade pip
pip install jsonschema rfc3339-validator

- name: Validate schema & examples
run: |
python - <<'PY'
import json, sys, glob
from jsonschema import Draft202012Validator

def load(p):
with open(p, 'r', encoding='utf-8') as f:
return json.load(f)

schema = load('schema/schema.json')
Draft202012Validator.check_schema(schema)
validator = Draft202012Validator(schema)

ok = True
for path in glob.glob('examples/*.ndjson'):
with open(path, 'r', encoding='utf-8') as f:
for i, line in enumerate(f, start=1):
if not line.strip():
continue
try:
rec = json.loads(line)
errs = list(validator.iter_errors(rec))
if errs:
ok = False
print(f'::error file={path},line={i}::Schema error: {errs[0].message}')
except json.JSONDecodeError as e:
ok = False
print(f'::error file={path},line={i}::Invalid JSON: {e}')
sys.exit(0 if ok else 1)
PY
